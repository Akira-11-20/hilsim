# RTT増加問題調査結果

## 調査日時
2025-09-24

## 問題の特定

### 段階的テスト結果

| テストパターン | 平均RTT | 標準偏差 | 範囲 | Growth Factor | 状態 |
|---------------|---------|----------|------|---------------|------|
| **REQ/REP (同期)** | 1.724ms | 0.113ms | 1.426-2.409ms | 0.93x | ✅ 安定 |
| **PUB/SUB (非同期)** | 1142.421ms | 58.701ms | 1014.961-1205.397ms | 1.09x | ⚠️ 高レイテンシ |

### 根本原因の特定

**PUB/SUBパターンの非同期バッファリングが原因**

1. **REQ/REP**: 同期通信、1対1対応、バッファリングなし
2. **PUB/SUB**: 非同期通信、メッセージキューに蓄積、RTT計算の複雑化

### 具体的な問題点

1. **メッセージバッファリング**
   - ZeroMQ内部でメッセージが蓄積
   - 送信と受信のタイミングが非同期

2. **RTT測定の困難**
   - コマンド送信と状態受信が別々のメッセージ
   - シーケンス番号の不一致

3. **固定レート処理**
   - 50Hz固定周期での処理
   - バッファ蓄積による遅延増加

## 元のHILSシステムでの現象

- RTT: 20ms → 1580ms+ (約79倍増加)
- 最終的に0.0msタイムアウト
- 通信が完全に破綻

## 推奨解決策

### Option 1: REQ/REPパターンへの変更
- 同期通信で確実な応答保証
- RTT測定が正確
- communication_test_containersと同様の安定性

### Option 2: PUB/SUBの最適化
- バッファサイズ制限
- タイムアウト設定の調整
- 非同期RTT測定方式の改善

### Option 3: ハイブリッドアプローチ
- 制御コマンド: REQ/REP (重要)
- 状態配信: PUB/SUB (パフォーマンス)

## テストファイル

- `tests/test_simple_communication.py` - 基本ZMQ動作確認
- `tests/test_rtt_measurement.py` - REQ/REP RTT測定
- `tests/test_pubsub_rtt.py` - PUB/SUB RTT測定

## 結論

HILSシステムのRTT増加問題は**通信パターンの選択**が根本原因。
PUB/SUBの非同期性がリアルタイム制御に適さないことが判明。

**次のステップ**: 元のHILS実装の詳細分析と修正方針の決定