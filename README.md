# HILS (Hardware-in-the-Loop Simulation) - UDP Architecture

å‚è€ƒæ§‹é€ ã«åŸºã¥ãé«˜æ€§èƒ½UDPé€šä¿¡ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«ã‚ˆã‚‹HILSã‚·ã‚¹ãƒ†ãƒ 

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  UDP    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Numeric     â”‚â—„â”€â”€â”€â”€â”€â–ºâ”‚      Plant      â”‚
â”‚   (UDP Client)  â”‚ Req/Res â”‚  (UDP Server)   â”‚
â”‚   PIDåˆ¶å¾¡å™¨     â”‚         â”‚   ç‰©ç†ã‚·ãƒŸãƒ¥    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                         â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚     Docker Network    â”‚
    â”‚      (hilsim)         â”‚
    â”‚                       â”‚
    â”‚ â€¢ Network emulation   â”‚
    â”‚ â€¢ Traffic control     â”‚
    â”‚ â€¢ Delay/Jitter        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“‹ ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ

### Core Components
- **Plant Server** (UDP Server): ç‰©ç†ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ + çŠ¶æ…‹å¿œç­”
- **Numeric Client** (UDP Client): PIDåˆ¶å¾¡ + ã‚³ãƒãƒ³ãƒ‰é€ä¿¡
- **UDP Protocol**: Network byte order ãƒ‘ã‚±ãƒƒãƒˆ + RTTæ¸¬å®š
- **Docker Network**: tc netem ã«ã‚ˆã‚‹é…å»¶åˆ¶å¾¡

### Key Features
- âœ… **é«˜æ€§èƒ½**: RTT 0.7-1msã€100%æˆåŠŸç‡
- âœ… **ã‚·ãƒ³ãƒ—ãƒ«**: UDP Request/Response
- âœ… **æ­£ç¢º**: Network byte order + ãƒã‚§ãƒƒã‚¯ã‚µãƒ 
- âœ… **åˆ¶å¾¡å¯èƒ½**: é…å»¶ãƒ»ã‚¸ãƒƒã‚¿ãƒ»æå¤±ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
- âœ… **åˆ†ææ©Ÿèƒ½**: RTTçµ±è¨ˆãƒ»ãƒ­ã‚°è¨˜éŒ²

## ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ

### 1. ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
```bash
make setup        # Pythonä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
make build        # Dockerã‚³ãƒ³ãƒ†ãƒŠãƒ“ãƒ«ãƒ‰
```

### 2. åŸºæœ¬å®Ÿè¡Œ
```bash
make up           # åŸºæœ¬ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
make logs         # ãƒ­ã‚°ç¢ºèª
make down         # åœæ­¢
```

### 3. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¡ä»¶ãƒ†ã‚¹ãƒˆ
```bash
make test-baseline      # é…å»¶ãªã—ï¼ˆãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ï¼‰
make test-fixed-delay   # å›ºå®šé…å»¶ï¼ˆ15ms Â± 5msï¼‰
make test-high-jitter   # é«˜ã‚¸ãƒƒã‚¿ï¼ˆ50ms Â± 20msï¼‰
make test-all-delays    # å…¨æ¡ä»¶ãƒ†ã‚¹ãƒˆ
```

## âš™ï¸ è¨­å®š

### ç’°å¢ƒå¤‰æ•°ï¼ˆ.envï¼‰
```bash
# ã‚·ã‚¹ãƒ†ãƒ è¨­å®š
MAX_STEPS=2500      # ã‚¹ãƒ†ãƒƒãƒ—æ•°ï¼ˆ50s at 50Hzï¼‰
RATE_HZ=50          # é€ä¿¡ãƒ¬ãƒ¼ãƒˆ
TIMEOUT_S=1.0       # UDP ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

# PIDåˆ¶å¾¡å™¨
KP=18.0             # æ¯”ä¾‹ã‚²ã‚¤ãƒ³
KI=5.0              # ç©åˆ†ã‚²ã‚¤ãƒ³
KD=8.0              # å¾®åˆ†ã‚²ã‚¤ãƒ³
SETPOINT=10.0       # é«˜åº¦è¨­å®šå€¤[m]
```

## ğŸ“Š é€šä¿¡ãƒ—ãƒ­ãƒˆã‚³ãƒ«

### UDP ãƒ‘ã‚±ãƒƒãƒˆæ§‹é€ 

**Requestï¼ˆNumericâ†’Plantï¼‰**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Sequence   â”‚     Timestamp       â”‚    Control Data     â”‚
â”‚  Number     â”‚     (double)        â”‚  [fx, fy, fz, ...]  â”‚
â”‚  (int32)    â”‚                     â”‚                     â”‚
â”‚  4 bytes    â”‚      8 bytes        â”‚    Variable         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Responseï¼ˆPlantâ†’Numericï¼‰**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Sequence   â”‚     Timestamp       â”‚    State Data       â”‚
â”‚  Number     â”‚     (double)        â”‚  [pos, vel, acc]    â”‚
â”‚  (int32)    â”‚                     â”‚                     â”‚
â”‚  4 bytes    â”‚      8 bytes        â”‚    Variable         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- **ã‚¨ãƒ³ãƒ‡ã‚£ã‚¢ãƒ³**: Network byte order (big-endian)
- **ãƒã‚§ãƒƒã‚¯ã‚µãƒ **: MD5ãƒãƒƒã‚·ãƒ¥ã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§
- **RTTæ¸¬å®š**: é«˜ç²¾åº¦perf_counterãƒ™ãƒ¼ã‚¹

## ğŸ“ˆ æ€§èƒ½ç‰¹æ€§

### RTTæ¸¬å®šçµæœ

| æ¡ä»¶ | å¹³å‡RTT | RTTç¯„å›² | æˆåŠŸç‡ | ç”¨é€” |
|------|---------|---------|--------|------|
| ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ | ~0.8ms | 0.4-1.2ms | 100% | æ€§èƒ½é™ç•Œæ¸¬å®š |
| å›ºå®šé…å»¶(15ms) | ~16ms | 14-18ms | 100% | ç¾å®Ÿçš„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ |
| é«˜ã‚¸ãƒƒã‚¿(Â±20ms) | ~52ms | 30-80ms | 98% | æ‚ªæ¡ä»¶ãƒ†ã‚¹ãƒˆ |

### ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆç‰¹æ€§
- **é€ä¿¡ãƒ¬ãƒ¼ãƒˆ**: 50Hzï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ï½ 100Hzï¼ˆé«˜é€Ÿï¼‰
- **ãƒ‘ã‚±ãƒƒãƒˆã‚µã‚¤ã‚º**: 32Bï¼ˆRequestï¼‰ã€56Bï¼ˆResponseï¼‰
- **æ¸¬å®šæ™‚é–“**: 50ç§’ï¼ˆ2500ã‚¹ãƒ†ãƒƒãƒ—ï¼‰

## ğŸ› ï¸ åˆ©ç”¨å¯èƒ½ã‚³ãƒãƒ³ãƒ‰

### åŸºæœ¬æ“ä½œ
```bash
make up             # ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
make down           # ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åœæ­¢
make restart        # å†èµ·å‹•
make status         # çŠ¶æ…‹ç¢ºèª
make logs           # ãƒ­ã‚°è¡¨ç¤º
```

### ãƒ†ã‚¹ãƒˆãƒ»åˆ†æ
```bash
make test-protocol  # ãƒ—ãƒ­ãƒˆã‚³ãƒ«ãƒ†ã‚¹ãƒˆ
make test-baseline  # ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆ
make test-all-delays# å…¨é…å»¶æ¡ä»¶ãƒ†ã‚¹ãƒˆ
make analyze        # ãƒ­ã‚°åˆ†æ
```

### é–‹ç™ºãƒ»ãƒ‡ãƒãƒƒã‚°
```bash
make build          # ã‚³ãƒ³ãƒ†ãƒŠãƒ“ãƒ«ãƒ‰
make clean          # ãƒªã‚½ãƒ¼ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
make help           # ãƒ˜ãƒ«ãƒ—è¡¨ç¤º
```

## ğŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
hilsim/
â”œâ”€â”€ plant/           # Plant UDP Serverå®Ÿè£…
â”œâ”€â”€ numeric/         # Numeric UDP Clientå®Ÿè£…
â”œâ”€â”€ shared/          # å…±é€šãƒ—ãƒ­ãƒˆã‚³ãƒ«å®Ÿè£…
â”œâ”€â”€ logs/            # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«
â”œâ”€â”€ simple_pid_control/  # PIDæ¤œè¨¼ç”¨ï¼ˆå‚è€ƒï¼‰
â”œâ”€â”€ archive/         # æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¿ç®¡
â”œâ”€â”€ docker-compose.yml      # ãƒ¡ã‚¤ãƒ³Dockerè¨­å®š
â”œâ”€â”€ docker-compose.delay.yml # é…å»¶ãƒ†ã‚¹ãƒˆè¨­å®š
â”œâ”€â”€ .env            # ç’°å¢ƒå¤‰æ•°è¨­å®š
â””â”€â”€ Makefile        # ãƒ“ãƒ«ãƒ‰ãƒ»å®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆ
```

## ğŸ”¬ æŠ€è¡“è©³ç´°

### Network Byte Order Protocol
- **struct format**: `"!IdfffQ"` (Request), `"!IdfffffffffQ"` (Response)
- **ãƒã‚§ãƒƒã‚¯ã‚µãƒ **: MD5ãƒãƒƒã‚·ãƒ¥ã«ã‚ˆã‚‹å®Œå…¨æ€§ç¢ºèª
- **ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—**: é«˜ç²¾åº¦RTTæ¸¬å®šç”¨

### Docker Network Control
```bash
# é…å»¶åˆ¶å¾¡ä¾‹
tc qdisc add dev eth0 root netem delay 15ms 5ms

# ãƒ‘ã‚±ãƒƒãƒˆæå¤±ä¾‹
tc qdisc add dev eth0 root netem delay 10ms loss 1%
```

### PIDåˆ¶å¾¡å™¨
- **å‹•ä½œç¢ºèªæ¸ˆã¿**: simple_pid_control/ ã§æ¤œè¨¼
- **æ¨å¥¨ã‚²ã‚¤ãƒ³**: Kp=18.0, Ki=5.0, Kd=8.0
- **Windupé˜²æ­¢**: ç©åˆ†é …åˆ¶é™ä»˜ã

## ğŸ“š å‚è€ƒ

- **é€šä¿¡ãƒ—ãƒ­ãƒˆã‚³ãƒ«**: communication_test_containerså‚è€ƒ
- **PIDåˆ¶å¾¡**: simple_pid_control/å®Ÿè£…ãƒ™ãƒ¼ã‚¹
- **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ¶å¾¡**: Linux tc netem
- **Docker**: Compose v2 + health checks

---

**ğŸš€ å‚è€ƒæ§‹é€ ãƒ™ãƒ¼ã‚¹ã®ã‚·ãƒ³ãƒ—ãƒ«ã§é«˜æ€§èƒ½ãªHILSã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**